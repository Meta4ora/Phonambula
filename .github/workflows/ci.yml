name: CI - Build, Docker & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.5
        options: --privileged
        ports:
          - 58080:58080

    steps:
      # 1 Получаем код
      - name: Checkout code
        uses: actions/checkout@v4

      # 2 Настраиваем JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3 Сборка Maven проекта
      - name: Build Maven project
        working-directory: ./server
        run: mvn -B clean verify

      # 4 Сборка Docker образа
      - name: Build Docker image
        working-directory: ./server
        run: |
          chmod +x mvnw
          docker build -t phonambula-backend:latest .

      - name: Run backend container
        id: run_backend
        run: |
          HOST_PORT=$(shuf -i 50000-60000 -n 1)
          echo "HOST_PORT=$HOST_PORT" >> $GITHUB_ENV
          docker run -d --name phonambula-backend -p $HOST_PORT:8080 phonambula-backend:latest
          echo "Backend running on port $HOST_PORT"
          sleep 20

      # 6 Ждём, чтобы сервис поднялся
      - name: Wait for backend
        run: |
          echo "Waiting 20s for backend to start..."
          sleep 20

      # 7 Тестируем /api/users
      - name: Test GET /api/users
        run: |
          RESPONSE=$(curl -s http://localhost:$HOST_PORT/api/users)
          echo "Ответ Users API:"
          echo "$RESPONSE"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$HOST_PORT/api/users)
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Users API failed with HTTP code $HTTP_CODE"
            exit 1
          fi

      # 8 Тестируем /api/roles
      - name: Test GET /api/roles
        run: |
          RESPONSE=$(curl -s http://localhost:$HOST_PORT/api/roles)
          echo "Ответ Roles API:"
          echo "$RESPONSE"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$HOST_PORT/api/roles)
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Roles API failed with HTTP code $HTTP_CODE"
            exit 1
          fi

      # 9 Останавливаем контейнер после тестов
      - name: Stop backend container
        run: docker stop phonambula-backend && docker rm phonambula-backend